{% load i18n %}
{% load url from future%}

{% if overcloud.is_deploying or overcloud.is_failed or overcloud.is_deleting %}
  {% if overcloud.is_deploying %}
    <div class="alert alert-info">
      <div class="row-fluid">
        <div class="span2">
          <strong>Deploying...</strong>
          <div class="progress progress-striped active progress-info">
            <div class="bar bar-info" style="width:{{ progress }}%"></div>
          </div>
        </div>
  {% elif overcloud.is_deleting %}
    <div class="alert alert-error">
      <div class="row-fluid">
        <div class="span2">
          <strong>Undeploying...</strong>
          <div class="progress progress-striped progress-danger">
            <div class="bar bar-info" style="width:{{ progress }}%"></div>
          </div>
        </div>
  {% else %}
    <div class="alert alert-error">
      <div class="row-fluid">
        <div class="span2">
          <strong>Deployment failed</strong>
          <div class="progress progress-striped progress-danger">
            <div class="bar bar-info" style="width:{{ progress }}%"></div>
          </div>
        </div>
  {% endif %}
    <div class="span10">
      {% if last_failed_events %}
        <strong>{% trans "Last failed events:" %}</strong>
        {% for event in last_failed_events %}
        <div>
          <dl>
            <dt>{% trans "Timestamp" %}</dt>
            <dd><time datetime="{{ event.event_time }}">{{ event.event_time }}</time></dd>
            <dt>{% trans "Resource Name" %}</dt>
            <dd>{{ event.resource_name }}</dd>
            <dt>{% trans "Status" %}</dt>
            <dd>{{ event.resource_status }}</dd>
            <dt>{% trans "Reason" %}</dt>
            <dd>{{ event.resource_status_reason }}</dd>
          </dl>
        </div>
        {% endfor %}
      {% endif %}
      <a href="?tab=detail__log" data-toggle="tab" data-target="#detail__log" class="pull-right">See full log</a>
    </div>
  </div>
</div>
{% endif %}

{% if not overcloud.dashboard_url %}
<div class="row-fluid">
  <div class="span8">
    <p>Your Overcloud has been successfully deployed. It needs to be initialized first, before you will be able to use it.
    <p/>

    <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#demo">
    Initialize
    </button>
    <div id="demo" class="collapse">
      <p>You need to run below commands on the machine where you have tripleo source code and
         direct access through ssh to control node ({{overcloud.keystone_ip}})
      </p>
      <pre>
  export TRIPLEO_ROOT=~/tripleo
  cd $TRIPLEO_ROOT

  # Be careful to source tripleorc here, some variables are rewritten below
  source $TRIPLEO_ROOT/tripleorc

  export OVERCLOUD_IP={{overcloud.keystone_ip}}

  export OVERCLOUD_ADMIN_TOKEN={{overcloud.attributes.AdminToken}}
  export OVERCLOUD_ADMIN_PASSWORD={{overcloud.attributes.AdminPassword}}
  export OVERCLOUD_CEILOMETER_PASSWORD={{overcloud.attributes.CeilometerPassword}}
  export OVERCLOUD_CINDER_PASSWORD={{overcloud.attributes.CinderPassword}}
  export OVERCLOUD_GLANCE_PASSWORD={{overcloud.attributes.GlancePassword}}
  export OVERCLOUD_HEAT_PASSWORD={{overcloud.attributes.HeatPassword}}
  export OVERCLOUD_NEUTRON_PASSWORD={{overcloud.attributes.NeutronPassword}}
  export OVERCLOUD_NOVA_PASSWORD={{overcloud.attributes.NovaPassword}}
  export OVERCLOUD_SWIFT_PASSWORD={{overcloud.attributes.SwiftPassword}}
  export OVERCLOUD_SWIFT_HASH={{overcloud.attributes.SwiftHashSuffix}}

  source ./tripleo-incubator/overcloudrc

  init-keystone -p $OVERCLOUD_ADMIN_PASSWORD $OVERCLOUD_ADMIN_TOKEN \
      $OVERCLOUD_IP admin@example.com heat-admin@$OVERCLOUD_IP \
      ${SSLBASE:+--ssl $PUBLIC_API_URL}
  setup-endpoints $OVERCLOUD_IP --cinder-password $OVERCLOUD_CINDER_PASSWORD \
      --glance-password $OVERCLOUD_GLANCE_PASSWORD \
      --heat-password $OVERCLOUD_HEAT_PASSWORD \
      --neutron-password $OVERCLOUD_NEUTRON_PASSWORD \
      --nova-password $OVERCLOUD_NOVA_PASSWORD \
      --swift-password $OVERCLOUD_SWIFT_PASSWORD \
      --enable-horizon \
      ${SSLBASE:+--ssl $PUBLIC_API_URL}
  keystone role-create --name heat_stack_user
  # Creating these roles to be used by tenants using swift
  keystone role-create --name=swiftoperator
  keystone role-create --name=ResellerAdmin
      </pre>
    </div>
  </div>
</div>
{% endif %}

<div class="row-fluid">
  <div class="span8">
    <h2>{% trans "Deployment Roles" %}</h2>
    <div class="widget">
      <table class="table">
      {% for role in roles %}
        <tr>
          <td><a
              href="{% url 'horizon:infrastructure:overcloud:role' overcloud.id role.role.id %}"
              >{{ role.name }} <span class="badge">({{ role.node_count }})</span></a>
          </td><td>
          {% if role.deploying_node_count %}
            <div class="text-warning">
              <i class="icon-cog"></i>
              {{ role.deploying_node_count }} / {{ role.node_count }}
              {{ role.deploying_node_message }}
            </div>
          {% elif role.error_node_count %}
            <div class="text-error">
              <i class="icon-warning"></i>
              {{ role.error_node_count }} / {{ role.node_count }}
              {{ role.error_node_message }}
            </div>
          {% elif role.node_count %}
            <div class="text-success">
              <i class="icon-ok"></i>
              {% trans "All nodes run correctly" %}
            </div>
          {% else %}
            <div class="muted">
              <i class="icon-minus"></i>
              {% trans "No nodes" %}
            </div>
          {% endif %}
          </td><td>
            {% if role.capacity %}
            <div class="row-fluid">
              <div class="span6"><p>{{ role.capacity }}%</p></div>
              <div class="span6">
                <div class="progress active progress-info">
                  <div class="bar bar-info" style="width:{{ role.capacity }}%"></div>
                </div>
              </div>
            </div>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </table>
    </div>
  </div>
  <div class="span4">
    <div class="widget">
      <h2>{% trans "Deployment Role Distribution" %}</h2>
      <div class="d3_pie_chart_distribution pull-left" data-used="{% for role in roles %}{{ role.name }}={{ role.node_count }}{% if not forloop.last %}|{% endif %}{% endfor %}"></div>
    </div>
    <div class="clear"></div>
    <div class="widget">
      <h2>{% trans "Horizon UI Connection" %}</h2>
      {% if overcloud.dashboard_url %}
      <p><a href="{{ overcloud.dashboard_url }}"
        >{% trans "Horizon UI" %} ({{ overcloud.dashboard_url }}).</a></p>
      {% else %}
         You need to initialize you Overcloud first.
      {% endif %}
    </div>
  </div>
</div>

<script type="text/javascript">
(window.$ || window.addHorizonLoadEvent)(function () {
  $('div > a[data-target="#detail__log"]').click(function () {
     $('li > a[data-target="#detail__log"]').tab('show');
  });
});
</script>
